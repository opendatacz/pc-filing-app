<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>PC Filing App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      footer {
        padding-top: 60px;
      }
    </style>
    <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="http://www.opendata.cz/mockup/pcfiler2/bootstrap/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://www.opendata.cz/mockup/pcfiler2/bootstrap/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://www.opendata.cz/mockup/pcfiler2/bootstrap/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://www.opendata.cz/mockup/pcfiler2/bootstrap/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="http://www.opendata.cz/mockup/pcfiler2/bootstrap/ico/apple-touch-icon-57-precomposed.png">
  
	<script src="bootstrap/js/jquery.js"></script>
	<script src="js/functions.js"></script>    
	<script src="js/sessionstorage.1.4.js"></script>
  
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="./">TenderStats <sup><i>BETA</i></sup></a>
          <div class="nav-collapse collapse">
            <ul class="nav pull-right">
              <li><a href="#"><i class="icon-search icon-white"></i></a></li>
              <li><a href="#"><i class="icon-question-sign icon-white"></i></a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span2">
          <div class="well" style="max-width: 360px; width:185px; padding: 8px 0;">
            <ul class="nav nav-list">
              <li class="nav-header disabled"><a href="#">My account</a></li>
              <li class="disabled"><a href="#">&nbsp;&nbsp;<i class="icon-user"></i>&nbsp;&nbsp;<div style="display:inline" id="username"></div></a></li>
			  <li class="disabled"><a href="#">&nbsp;&nbsp;<i class=" icon-wrench"></i>&nbsp;&nbsp;Account settings</a></li>
              <li><a onclick="sessionStorage.clear();" href="SystemManager?action=logout&forward=.%2F%3Ft%3Dinfo%26m%3D%3Cstrong%3EYou%20have%20been%20successfully%20logged%20out.%3C%2Fstrong%3E">&nbsp;&nbsp;<i class=" icon-off"></i>&nbsp;&nbsp;Logout</a></li>
              <li class="nav-header"><a href="my-events.html">My Events</a></li>
              <li ><a href="my-events.html">&nbsp;&nbsp;<i class="icon-edit"></i>&nbsp;&nbsp;non-published</a></li>
              <li class=""><a href="withdrawn-calls-for-tenders.html">&nbsp;&nbsp;<i class="icon-edit"></i>&nbsp;&nbsp;withdrawn</a></li>
              <li class=""><a href="calls-for-tenders.html">&nbsp;&nbsp;<i class="icon-globe"></i>&nbsp;&nbsp;calls for tenders</a></li>
              <li class=""><a href="awarded-calls-for-tenders.html">&nbsp;&nbsp;<i class="icon-folder-open"></i>&nbsp;&nbsp;awarded</a></li>
              <li class=""><a href="completed-calls-for-tenders.html">&nbsp;&nbsp;<i class="icon-folder-close"></i>&nbsp;&nbsp;completed</a></li>
              <li class="divider"></li>
              <li><a href="create-event.html" class="btn btn-primary" style="text-align:left; margin-left:0px; margin-right:10px; margin-top: 5px; padding-left: 0px;" title="Click here to create a new event.">&nbsp;&nbsp;<i class="icon-plus"></i>&nbsp;&nbsp;create event</a></li>
              <li class="divider"></li>
              <li class="nav-header disabled"><a href="#">Analytics</a></li>
              <li class="disabled"> <a href="#">&nbsp;&nbsp;<i class="icon-signal"></i>&nbsp;&nbsp;pricing</a></li>
              <li class="disabled"> <a href="#">&nbsp;&nbsp;<i class="icon-signal"></i>&nbsp;&nbsp;saving</a></li>
              <li class="divider"></li>
              <li class="disabled"><a href="#" class="btn" style="text-align:left; margin-left:0px; margin-right:10px; margin-top: 5px; padding-left: 0px;">&nbsp;&nbsp;<i class="icon-plus"></i>&nbsp;&nbsp;create analysis</a></li>
              <li class="divider"></li>
            </ul>
          </div>
        </div>
        <div class="span9">
          
          <h3 style="margin-bottom: 20px;">Events similar to your event '<div style="display:inline;" id="contractTitle"></div>'.</h3>
          
		  <!--
		  <div class="btn-group btn-group">
             <a href="mycontracts-step-05.html" class="btn btn-small" title="Click to compare your contract with this one.">compare</a>
          </div>
		  -->
            
          <table class="table table-striped table-bordered" style="display:none;" id="contractTable">
            <thead>
              <tr>
                <th>Similarity</th>
                <th>Contract title</th>
                <th>Place</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
		  
		  <div style="text-align: center;" id="progressbar"><br><img src="images/progressbar.gif"/></div>
          
          <div class="pagination pagination-centered">
            <ul id="pages">
			
            </ul>
          </div>
		  
		  <div id="showAllPages" class="hide pagination pull-right" style="margin:0; margin-top:-16px;">
		  <ul>
				<li><a onclick="$('.3dots').remove(); $('#pages li').removeClass('reallyhide');" href="#">show all pages</a>
				</li>
		  </ul>
		  </div>
		  
        </div>
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="bootstrap/js/bootstrap-transition.js"></script>
    <script src="bootstrap/js/bootstrap-alert.js"></script>
    <script src="bootstrap/js/bootstrap-modal.js"></script>
    <script src="bootstrap/js/bootstrap-dropdown.js"></script>
    <script src="bootstrap/js/bootstrap-scrollspy.js"></script>
    <script src="bootstrap/js/bootstrap-tab.js"></script>
    <script src="bootstrap/js/bootstrap-tooltip.js"></script>
    <script src="bootstrap/js/bootstrap-popover.js"></script>
    <script src="bootstrap/js/bootstrap-button.js"></script>
    <script src="bootstrap/js/bootstrap-collapse.js"></script>
    <script src="bootstrap/js/bootstrap-carousel.js"></script>
    <script src="bootstrap/js/bootstrap-typeahead.js"></script>

	<script type="text/javascript">
	var pagesTotal = 1;
	var currentPage = 1;
	var windowSize = 3;	// in each direction from the current page
	
	var contractURL = sessionStorage.contractURL;
	var title = sessionStorage.contractTitle;
	var cpvString = sessionStorage.contractCpvString;
	var price = sessionStorage.contractPrice;
	var currency = sessionStorage.contractCurrency;

	function initPages()
	{
		$.getJSON("Matchmaker?action=getSimilarContractsPages&contractURL=" + encodeURIComponent(contractURL) + "&cpvString=" + encodeURIComponent(cpvString), function(data)
		{
			pagesTotal = data;
			
			if (pagesTotal <= 1) {
				return;
			}
				
			if (pagesTotal > windowSize + 2) {
				$('#showAllPages').removeClass("hide"); 
			}

			$("#pages").append('<li><a href="#" id="loadPreviousContracts">Prev</a></li>');
			$("#loadPreviousContracts").click(function() {
				if ($(this).parent().hasClass("disabled")) {
					return false;
				};
				currentPage--;
				togglePageButtons();
				loadContracts();
			});

			for (var i = 1; i <= pagesTotal; i++) {
				$("#pages").append('<li><a href="#" id="loadContractsPage' + i +'">' + i +'</a></li>');
				$("#loadContractsPage" + i).on('click', function() {
					if ($(this).parent().hasClass("active")) {
						return false;
					};
					currentPage = parseInt($(this).attr("id").match(/(\d+)$/)[0], 10);
					togglePageButtons();
					loadContracts();
				});			
			}

			$("#pages").append('<li><a href="#" id="loadNextContracts">Next</a></li>');
			$("#loadNextContracts").click(function() {
				if ($(this).parent().hasClass("disabled")) {
					return false;
				};
				currentPage++;
				togglePageButtons();
				loadContracts();
			});			

			togglePageButtons();
		}
		);
	}
	
	function loadContracts()
	{
		$.getJSON("Matchmaker?action=getSimilarContracts&contractURL=" + encodeURIComponent(contractURL) + "&cpvString=" + encodeURIComponent(cpvString) + "&from=" + 10 * (currentPage - 1) + "&to=" + 10 * currentPage, function(data)
		{
			$('#progressbar').hide();
			$('#contractTable').fadeIn('slow');	
			$('#contractTable tbody').remove();	
			$.each(data, function(i,data){
				var div_data = '<tr style="vertical-align: middle;">                  <td>  </td>                  <td title="' + htmlEncode(data.description) + '">' + htmlEncode(data.title) + '</td>                  <td>' + htmlEncode(data.place) + '<br>                  </td>                  <td style="vertical-align:middle;"><div class="btn-group btn-group">                      <a onclick="compareWith(\'' + encodeURIComponent(data.contractURL) + '\', \'' + encodeURIComponent(data.title) + '\', \'' + encodeURIComponent(data.description) + '\', \'' + encodeURIComponent(data.price) + '\', \'' + encodeURIComponent(data.currency) + '\', \'' + encodeURIComponent(data.cpv)  + '\', \'' + encodeURIComponent(data.place) + '\');" class="btn btn-small btn-primary" href="compare-contracts.html" data-original-title="">Compare</a> </div>                  </td>                </tr>';
				$(div_data).appendTo("#contractTable");
			});
			$('td').tooltip();
		});
	}
	
	function togglePageButtons() {
		$("#pages li").addClass("reallyhide");
		$("#loadPreviousContracts").parent().removeClass("reallyhide");
		$("#loadNextContracts").parent().removeClass("reallyhide");
		$("#loadContractsPage" + 1).parent().removeClass("reallyhide");
		$("#loadContractsPage" + pagesTotal).parent().removeClass("reallyhide");
		
		$("#pages li").removeClass("active");
		if (currentPage == 1) {
			$("#loadPreviousContracts").parent().addClass("disabled");
		} else {
			$("#loadPreviousContracts").parent().removeClass("disabled");
		};
		if (currentPage == pagesTotal) {
			$("#loadNextContracts").parent().addClass("disabled");
		} else {
			$("#loadNextContracts").parent().removeClass("disabled");
		};
		$("#loadContractsPage" + currentPage).parent().addClass("active");
		
		for (var i = currentPage - windowSize; i <= currentPage + windowSize; i++) {
			if (i > 1 && i < pagesTotal) {
				$("#loadContractsPage" + i).parent().removeClass("reallyhide");
			}
		}
		
		$(".3dots").remove();
		if ((currentPage - windowSize - 1 >= 1) && $("#loadContractsPage" + (currentPage - windowSize - 1)).parent().hasClass('reallyhide')) {
			$("#loadContractsPage" + (currentPage - windowSize - 1)).parent().after('<li class="3dots disabled"><a href="#">...</a></li>');
		}
		if ((currentPage + windowSize + 1 <= pagesTotal) && $("#loadContractsPage" + (currentPage + windowSize + 1)).parent().hasClass('reallyhide')) {
			$("#loadContractsPage" + (currentPage + windowSize + 1)).parent().before('<li class="3dots disabled"><a href="#">...</a></li>');
		}
	}
	
	$(window).ready(function() {
		$('#contractTitle').append(title);
		checkUser();
		initPages();
		loadContracts();
	});
	

	function checkUser() {
		if (sessionStorage.username != undefined) {
			$("#username").append(sessionStorage.username);
		}
		$.getJSON("SystemManager?action=getuser", function(data)
		{
			if (data == null || data.length == 0) {
				sessionStorage.clear();
				window.location.href = "./";
			} else {
				$("#username").html(data);
				sessionStorage.username = data;
			}
		});
	}

	function compareWith(contractURL, title, description, price, currency, cpvString, place) {
		sessionStorage.contractURL2 = decodeURIComponent(contractURL);
		sessionStorage.contractTitle2 = decodeURIComponent(title);
		sessionStorage.contractDescription2 = decodeURIComponent(description);
		sessionStorage.contractPrice2 = decodeURIComponent(price);
		sessionStorage.contractCurrency2 = decodeURIComponent(currency);
		sessionStorage.contractCpvString2 = decodeURIComponent(cpvString);
		sessionStorage.contractPlace2 = decodeURIComponent(place);
	}	
	
    $("a").tooltip();
    </script>
  </body>
</html>