<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Wealh of Nation</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="">

	<!-- Le styles -->
	<link href="./bootstrap/css/bootstrap.css" rel="stylesheet">	
	<link href="./bootstrap/css/won.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	<style type="text/css">
	body {
		padding-top: 60px;
		padding-bottom: 40px;
	}
	
	.sidebar-nav {
		padding: 9px 0;
	}
	
	.activities tr td {
		padding-top: 20px;
		padding-bottom: 20px;
	}
	</style>
	<link href="./bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
	<link href="css/jquery-ui.css" rel="stylesheet">

	<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
	<!--[if lt IE 9]>
      	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
   	<![endif]-->
</head>

<body>

	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container-fluid">
				<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span
					class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
				</a> <a class="brand" href="#">PC Filing App <sup><i>with Product Ontologies</i></sup></a>
				<div class="nav-collapse collapse">
					<p class="navbar-text pull-right">
						Logged in as <a id="username" href="#" class="navbar-link"></a> <a href="SystemManager?action=logout&forward=.%2F%3Ft%3Dinfo%26m%3D%3Cstrong%3EYou%20have%20been%20successfully%20logged%20out.%3C%2Fstrong%3E" class="navbar-link" style="margin-left: 1em "><i class="icon-off icon-white"></i></a> 						
					</p>
					<ul class="nav">
						<li><a href="#" id="enableGuide" onclick="userHelper('on')">Help</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span2">
				<div class="well sidebar-nav">
					<ul class="nav nav-list">
						<li><a href="buyer-dashboard.html"><i class="icon-home"></i>&nbsp;&nbsp;&nbsp;Dashboard</a></li>
						<li class="divider"></li>
						<li class="nav-header">My calls for tenders</li>
						<li><a href="buyer-prepared.html">Calls in preparation</a></li>
						<li class=""><a href="buyer-published.html">Published calls</a></li>
						<li><a href="buyer-cancelled.html">Cancelled calls</a></li>
						<li class="divider"></li>
						<li><a href="buyer-create-event.html" class="btn btn-small" style="margin-left: 10px; margin-right: 10px;">Create	call</a></li>
						<li class="divider"></li>
						<li class="nav-header">My contracts</li>
						<li><a href="buyer-awarded.html">Awarded contracts</a></li>
						<li><a href="buyer-completed.html">Completed contracts</a></li>
						<li><a href="buyer-withdrawn.html">Withdrawn contracts</a></li>
						<li class="divider"></li>
						<li class="nav-header">Search public cloud</li>
						<li class="disabled"><a href="#">Search calls for tenders</a></li>
						<li class="disabled"><a href="#">Search contracts</a></li>
						<li class="disabled"><a href="#">Search suppliers</a></li>
					</ul>
				</div>
			</div>

			<div class="span8">
          
          <h3 style="margin-bottom: 20px;">Events similar to your event '<span style="display:inline;" id="contractTitle"></span>'.</h3>
          
		  <!--
		  <div class="btn-group btn-group">
             <a href="mycontracts-step-05.html" class="btn btn-small" title="Click to compare your contract with this one.">compare</a>
          </div>
		  -->
            
          <table class="table table-striped table-bordered" style="display:none;" id="contractTable">
            <thead>
              <tr>
                <th>Similarity</th>
                <th>Contract title</th>
                <th>Place</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
		  
		  <div style="text-align: center;" id="progressbar"><br><img src="images/progressbar.gif"/></div>
          
          <div class="pagination pagination-centered">
            <ul id="pages">
			
            </ul>
          </div>
		  
		  <div id="showAllPages" class="hide pagination pull-right" style="margin:0; margin-top:-16px;">
		  <ul>
				<li><a onclick="$('.3dots').remove(); $('#pages li').removeClass('reallyhide');" href="#">show all pages</a>
				</li>
		  </ul>
		  </div>
		  
        </div>
        <div class="span2">				
				<div class="box">
					<div class="box-header">
						<h2>My Stats</h2>
						<div class="box-icon">
							<a href="#" id="statsHide" class="btn-close">
								<i onclick="userStats('true');" class="icon-plus"></i>
								<i onclick="userStats('false');" class="icon-minus hide"></i>
							</a> <a href="#" class="btn-close"><i class="icon-remove"></i></a>
						</div>
					</div>					
					<div class="box-content">
						<table class="table table-condensed hide" id="statsTable">						
							<tr id="statsPrepared">
								<td>Calls in preparation</td>
								<td>0</td>
							</tr>
							<tr id="statsPublished">
								<td>Published calls</td>
								<td>0</td>
							</tr>
							<tr id="statsCancelled">
								<td>Cancelled calls</td>
								<td>0</td>
							</tr>							
							<tr id="statsAwarded">
								<td>Awarded contracts</td>
								<td>0</td>
							</tr>
							<tr id="statsCompleted">
								<td>Completed contracts</td>
								<td>0</td>
							</tr>
							<tr id="statsWithdrawn">
								<td>Withrawn contracts</td>
								<td>0</td>
							</tr>							
						</table>
					</div>
				</div>
			
			
			
			
			
			
			
          <div class="box">
          <div id="refine" style="display:none;">
          <div class="box-header">
            <h2>Refine matchmaker results</h2>
          </div>
          <div class="box-content">
            <form id="refineForm" style="margin:5px">
            <input type="hidden" name="refine" value="true">
                <label>Age:</label>
                <input name="dateFrom" class="input-small hasDatePicker" type="text" placeholder="Date from ..." /> - <input name="dateTo" class="input-small hasDatePicker" type="text" placeholder="Date to ..." />
                <label>Price:</label>
                <input disabled name="priceFrom" class="input-small" type="text" placeholder="Min price ..." /> - <input disabled name="priceTo" class="input-small" type="text" placeholder="Max price ..." />
                <select disabled name="priceCurrency" style="width:60px">
                  <option>EUR</option>
                  <option>USD</option>
                </select>
                <label>Distance (in km):</label>
                <input name="maxDistance" class="input-small" type="text" placeholder="Max distance ..." />
                <label>Countries:</label>
                <select name="countries" style="width:160px" multiple="multiple">
                  <option value="-- any --">-- any --</option>
<option value="Austria">Austria</option>
<option value="Belgium">Belgium</option>
<option value="Bulgaria">Bulgaria</option>
<option value="Cyprus">Cyprus</option>
<option value="Czech Republic">Czech Republic</option>
<option value="Denmark">Denmark</option>
<option value="Estonia">Estonia</option>
<option value="Finland">Finland</option>
<option value="France">France</option>
<option value="Germany">Germany</option>
<option value="Greece">Greece</option>
<option value="Hungary">Hungary</option>
<option value="Ireland">Ireland</option>
<option value="Island">Island</option>
<option value="Italy">Italy</option>
<option value="Latvia">Latvia</option>
<option value="Lithuania">Lithuania</option>
<option value="Luxembourg">Luxembourg</option>
<option value="Macedonia">Macedonia</option>
<option value="Malta">Malta</option>
<option value="Netherlands">Netherlands</option>
<option value="Norway">Norway</option>
<option value="Poland">Poland</option>
<option value="Portugal">Portugal</option>
<option value="Romania">Romania</option>
<option value="Slovakia">Slovakia</option>
<option value="Slovenia">Slovenia</option>
<option value="Spain">Spain</option>
<option value="Sweden">Sweden</option>
<option value="Switzerland">Switzerland</option>
<option value="United Kingdom">United Kingdom</option>
<option value="United States">United States</option>
                </select>
                <label>Similarity:</label>
                <input name="minScore" class="input-small" type="text" placeholder="Min similarity ..." />% - <input name="maxScore" class="input-small" type="text" placeholder="Max similarity ..." />%
                <button name="submit" onclick='refineResults(); return false;' class="btn btn-primary">Refine!</button>
            </form>
          </div>
          </div>
          </div>
			
			
	</div>	
			
			
			
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    
    <script src="bootstrap/js/jquery.js"></script>
    <script src="bootstrap/js/bootstrap-transition.js"></script>
    <script src="bootstrap/js/bootstrap-alert.js"></script>
    <script src="bootstrap/js/bootstrap-modal.js"></script>
    <script src="bootstrap/js/bootstrap-dropdown.js"></script>
    <script src="bootstrap/js/bootstrap-scrollspy.js"></script>
    <script src="bootstrap/js/bootstrap-tab.js"></script>
    <script src="bootstrap/js/bootstrap-tooltip.js"></script>
    <script src="bootstrap/js/bootstrap-popover.js"></script>
    <script src="bootstrap/js/bootstrap-button.js"></script>
    <script src="bootstrap/js/bootstrap-collapse.js"></script>
    <script src="bootstrap/js/bootstrap-carousel.js"></script>
    <script src="bootstrap/js/bootstrap-typeahead.js"></script>

	<!--<script src="js/cpvs.js"></script>-->
	<script src="js/functions.js"></script>
	<script src="js/jquery-ui.js"></script>
	<script src="js/sessionstorage.1.4.js"></script>
	<script src="js/script.js"></script>
	<script src="js/date.format.js"></script>	
	<script src="js/toolsBuyer.js"></script>
	<script src="js/table.js"></script>

	<script type="text/javascript">
	var pagesTotal = 1;
	var currentPage = 1;
	var windowSize = 3;	// in each direction from the current page
	
	var arrdata = [];
	
	var contractURL = sessionStorage.contractURL;
	var title = sessionStorage.contractTitle;
	// var cpvString = sessionStorage.contractCpvString; // todo remove all traces?
	var price = sessionStorage.contractPrice;
	var currency = sessionStorage.contractCurrency;

	var refineParams = "";
	
	function initRefineParams() {
		refineParams = "";
		$("form#refineForm :input").each(function(){
			var input = $(this); 
			refineParams += "&" + input.attr("name") + "=" + encodeURIComponent(input.val());					
		});
		//alert(refineParams);
	}
	
	function refineResults() {
		$('#progressbar').show();
		$('#contractTable').hide();
		$('#refine').hide();
		initRefineParams();
		initPages();
		loadContracts();
	}
	
	function initPages()
	{
		$.getJSON("Matchmaker?action=getSimilarContractsPages&contractURL=" + encodeURIComponent(contractURL) + refineParams, function(data)
		{
			pagesTotal = data;
				
			if (pagesTotal > windowSize + 2) {
				$('#showAllPages').removeClass("hide"); 
			}
			
			$("#pages").empty();

			$("#pages").append('<li><a href="#" id="loadPreviousContracts">Prev</a></li>');
			$("#loadPreviousContracts").off('click');
			$("#loadPreviousContracts").click(function() {
				if ($(this).parent().hasClass("disabled")) {
					return false;
				};
				currentPage--;
				togglePageButtons();
				loadContracts();
			});

			for (var i = 1; i <= pagesTotal; i++) {
				$("#pages").append('<li><a href="#" id="loadContractsPage' + i +'">' + i +'</a></li>');
				$("#loadContractsPage" + i).on('click', function() {
					if ($(this).parent().hasClass("active")) {
						return false;
					};
					currentPage = parseInt($(this).attr("id").match(/(\d+)$/)[0], 10);
					togglePageButtons();
					loadContracts();
				});			
			}

			$("#pages").append('<li><a href="#" id="loadNextContracts">Next</a></li>');
			$("#loadNextContracts").off('click');
			$("#loadNextContracts").click(function() {
				if ($(this).parent().hasClass("disabled")) {
					return false;
				};
				currentPage++;
				togglePageButtons();
				loadContracts();
			});			

			togglePageButtons();
		}
		);
	}
	
	function loadContracts()
	{
		$.getJSON("Matchmaker?action=getSimilarContracts&contractURL=" + encodeURIComponent(contractURL) + "&from=" + 10 * (currentPage - 1) + "&to=" + 10 * currentPage + refineParams, function(data)
		{
			$('#progressbar').hide();
			$('#contractTable').fadeIn('slow');
			$('#refine').fadeIn('slow');
			$('#contractTable tbody').remove();	
			$.each(data, function(i,data){
				arrdata[i] = data;
				var div_data = '<tr style="vertical-align: middle;"><td style="text-align: center;"> ' +
				'<a onclick="compareWith(\'' + i + '\');" href="compare-contracts.html?mm" data-original-title="">' +
				htmlEncode(data.percent.toFixed(1)) +
				'%</a></td><td title="' + htmlEncode(data.description) + '">' + htmlEncode(data.title) + 
				'</td><td>' + htmlEncode(data.place) + '<br></td><td style="vertical-align:middle;">' + 
				'<div class="btn-group btn-group"><a onclick="compareWith(\'' + i + 
				'\');" class="btn btn-small" href="compare-contracts.html" data-original-title="">' + 
				'Compare</a> </div></td></tr>';
				$(div_data).appendTo("#contractTable");
			});
			$('td').tooltip();
		});
	}
	
	function togglePageButtons() {
		$("#pages li").addClass("reallyhide");
		$("#loadPreviousContracts").parent().removeClass("reallyhide");
		$("#loadNextContracts").parent().removeClass("reallyhide");
		$("#loadContractsPage" + 1).parent().removeClass("reallyhide");
		$("#loadContractsPage" + pagesTotal).parent().removeClass("reallyhide");
		
		$("#pages li").removeClass("active");
		if (currentPage <= 1) {
			$("#loadPreviousContracts").parent().addClass("disabled");
		} else {
			$("#loadPreviousContracts").parent().removeClass("disabled");
		};
		if (currentPage >= pagesTotal) {
			$("#loadNextContracts").parent().addClass("disabled");
		} else {
			$("#loadNextContracts").parent().removeClass("disabled");
		};
		$("#loadContractsPage" + currentPage).parent().addClass("active");
		
		for (var i = currentPage - windowSize; i <= currentPage + windowSize; i++) {
			if (i > 1 && i < pagesTotal) {
				$("#loadContractsPage" + i).parent().removeClass("reallyhide");
			}
		}
		
		$(".3dots").remove();
		if ((currentPage - windowSize - 1 >= 1) && $("#loadContractsPage" + (currentPage - windowSize - 1)).parent().hasClass('reallyhide')) {
			$("#loadContractsPage" + (currentPage - windowSize - 1)).parent().after('<li class="3dots disabled"><a href="#">...</a></li>');
		}
		if ((currentPage + windowSize + 1 <= pagesTotal) && $("#loadContractsPage" + (currentPage + windowSize + 1)).parent().hasClass('reallyhide')) {
			$("#loadContractsPage" + (currentPage + windowSize + 1)).parent().before('<li class="3dots disabled"><a href="#">...</a></li>');
		}
	}
	
	$(window).ready(function() {
		$(".hasDatePicker").datepicker({ dateFormat: 'yy-mm-dd' });
		$('#contractTitle').append(title);
		checkUser();
		initPages();
		loadContracts();
	});
	

	function checkUser() {
		if (sessionStorage.username != undefined) {
			$("#username").append(sessionStorage.username);
		}
		$.getJSON("SystemManager?action=getuser", function(data)
		{
			if (data == null || data.length == 0) {
				sessionStorage.clear();
				window.location.href = "./";
			} else {
				$("#username").html(data);
				sessionStorage.username = data;
			}
		});
	}

	function compareWith(i) {
		var data = arrdata[i];
		sessionStorage.contractURL2 = data.contractURL;
		sessionStorage.contractTitle2 = data.title;
		sessionStorage.contractDescription2 = data.description;
		sessionStorage.contractPrice2 = data.price;
		sessionStorage.contractCurrency2 = data.currency;
		//sessionStorage.contractCpvString2 = data.cpvString;
		sessionStorage.contractPlace2 = data.place;
		sessionStorage.comparerMessages = JSON.stringify(data.comparerMessages);
		sessionStorage.contractTriplesURL2 = data.triplesURL;
	}
	
    $("a").tooltip();
    </script>
  </body>
</html>